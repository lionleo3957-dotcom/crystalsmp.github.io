<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CRYSTAL SMP Voting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b1220;color:#fff;margin:0;padding:0}
    header{text-align:center;padding:30px;background:#111a33}
    h1{margin:0;color:#00e5ff}
    .container{max-width:900px;margin:auto;padding:20px}
    .card{background:#162044;border-radius:10px;padding:20px;margin-bottom:20px}
    button{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;background:#00e5ff;color:#000;font-weight:bold}
    button.red{background:#ff4d4d;color:#fff}
    button.gray{background:#888;color:#000}
    .btn-home{background:transparent;border:2px solid #00e5ff;color:#00e5ff}
    input{width:100%;padding:10px;border-radius:6px;border:none;margin:8px 0}
    .hidden{display:none}
    .center{text-align:center}
    a{color:#00e5ff;cursor:pointer}
    ul{list-style:none;padding:0}
    li{margin:6px 0}
  </style>
</head>
<body>
<header>
  <h1>CRYSTAL SMP</h1>
  <p>Vote once per month to support the server</p>
</header>

<div class="container">

<!-- LOGIN -->
<div class="card hidden" id="loginCard">
  <h2>üîê Login</h2>
  <input type="text" id="username" placeholder="Minecraft Username">
  <input type="password" id="password" placeholder="Password">
  <div class="center">
    <button onclick="login()">Login</button>
    <button class="btn-home" onclick="goHome()">Back to Home</button>
  </div>
</div>

<!-- VOTING -->
<div class="card hidden" id="voteCard">
  <h2 class="center">üó≥Ô∏è Cast Your Vote</h2>
  <p class="center">Election Type: <b>Leader Election</b></p>

  <div class="card">
    <h3>Umer</h3>
    <p>Party: MPI</p>
    <button onclick="castVote('Umer')">Vote for Umer</button>
  </div>

  <div class="card">
    <h3>Usman</h3>
    <p>Party: UTI</p>
    <button onclick="castVote('Usman')">Vote for Usman</button>
  </div>

  <p id="voteMsg" class="center"></p>

  <div class="center">
    <button class="gray" onclick="logout()">Logout</button>
    <button class="btn-home" onclick="goHome()">Back to Home</button>
  </div>
</div>

<!-- LEADERBOARD -->
<div class="card hidden" id="leaderboardCard">
  <h2>üèÜ Top Voters Leaderboard</h2>
  <ul id="leaderboard"></ul>
</div>

<!-- HISTORY -->
<div class="card hidden" id="historyCard">
  <h2>üßæ Vote History</h2>
  <ul id="history"></ul>
</div>

<!-- ADMIN -->
<div class="card hidden" id="adminCard">
  <h2>üëë Admin Panel</h2>
  <button class="red" onclick="resetVotes()">Reset All Votes</button>
  <button onclick="toggleVoting(true)">Start Voting</button>
  <button onclick="toggleVoting(false)">Stop Voting</button>
  <p id="adminMsg"></p>
</div>

</div>

<script>
// Storage keys
const USERS='csmp_users';
const SESSION='csmp_session';
const VOTES='csmp_votes';
const HISTORY='csmp_history';
const SETTINGS='csmp_settings';

// ADMIN CREDENTIALS (CHANGE THESE)
const ADMIN_USER='AdminLeo';
const ADMIN_PASS='Admin@123';

function getData(key,def){return JSON.parse(localStorage.getItem(key))||def}
function setData(key,val){localStorage.setItem(key,JSON.stringify(val))}

function login(){
  const u=username.value.trim();
  const p=password.value.trim();
  if(!u||!p){alert('Invalid try again');return}

  // ADMIN LOGIN
  if(u===ADMIN_USER && p===ADMIN_PASS){
    setData(SESSION,{user:u,role:'admin'});
    showVote();
    return;
  }

  let users=getData(USERS,{});
  if(users[u] && users[u]!==p){alert('Invalid try again');return}

  users[u]=p; // permanent password
  setData(USERS,users);
  setData(SESSION,{user:u,role:'voter'});
  showVote();
}

function showVote(){
  loginCard.classList.add('hidden');
  voteCard.classList.remove('hidden');
  leaderboardCard.classList.remove('hidden');
  historyCard.classList.remove('hidden');

  const session=getData(SESSION,null);
  if(session && session.role==='admin'){
    adminCard.classList.remove('hidden');
  }

  loadLeaderboard();
  loadHistory();
}

function logout(){
  localStorage.removeItem(SESSION);
  location.reload();
}

function castVote(candidate){
  const session=getData(SESSION,null);
  if(!session){alert('Login required');return}

  const settings=getData(SETTINGS,{voting:true});
  if(!settings.voting && session.role!=='admin'){
    voteMsg.innerText='‚õî Voting is stopped by Admin';
    return;
  }

  let votes=getData(VOTES,{});
  const month=new Date().getMonth();

  if(session.role!=='admin' && votes[session.user] && votes[session.user].month===month){
    voteMsg.innerText='‚ùå You already voted this month';
    return;
  }

  votes[session.user]={candidate,month};
  setData(VOTES,votes);

  let hist=getData(HISTORY,[]);
  hist.push({user:session.user,candidate,date:new Date().toLocaleString()});
  setData(HISTORY,hist);

  voteMsg.innerText='‚úÖ Vote Cast Successfully';
  loadLeaderboard();
  loadHistory();
}

function loadLeaderboard(){
  const votes=getData(VOTES,{});
  let count={};
  Object.values(votes).forEach(v=>{count[v.candidate]=(count[v.candidate]||0)+1});
  leaderboard.innerHTML='';
  for(let c in count){
    const li=document.createElement('li');
    li.textContent=`${c}: ${count[c]} votes`;
    leaderboard.appendChild(li);
  }
}

function loadHistory(){
  const hist=getData(HISTORY,[]);
  history.innerHTML='';
  hist.forEach(h=>{
    const li=document.createElement('li');
    li.textContent=`${h.user} voted for ${h.candidate} on ${h.date}`;
    history.appendChild(li);
  });
}

function resetVotes(){
  const session=getData(SESSION,null);
  if(!session || session.role!=='admin'){
    alert('Not allowed');return;
  }
  if(confirm('Are you sure?')){
    localStorage.removeItem(VOTES);
    localStorage.removeItem(HISTORY);
    loadLeaderboard();
    loadHistory();
  }
}

function toggleVoting(state){
  setData(SETTINGS,{voting:state});
  adminMsg.innerText= state ? '‚úÖ Voting Started' : '‚õî Voting Stopped';
}

function goHome(){
  // ONLY GO TO HOME (HEADER), NOT LOGIN
  voteCard.classList.add('hidden');
  leaderboardCard.classList.add('hidden');
  historyCard.classList.add('hidden');
  adminCard.classList.add('hidden');

  // login stays hidden unless logout
  loginCard.classList.add('hidden');

  // jump to top (CRYSTAL SMP)
  window.scrollTo(0,0);
}

// Auto login if session exists
if(getData(SESSION,null)) showVote();
</script>
</body>
</html>
